#### 接口层限流（API）、业务方法限流：
线程数限流、计数器、Sentinel、Hystrix



#### 高并发的处理指标

高并发（High Concurrency）是一种系统运行过程中遇到的一种“短时间内遇到大量操作请求”的情况

1、响应时间（Response Time）

响应时间：系统对请求做出响应的时间。例如系统处理一个HTTP请求需要200ms，这个200ms就是系
统的响应时间

2、吞吐量（Throughput）

吞吐量：单位时间内处理的请求数量。

3、每秒查询率QPS（Query Per Second）

QPS：每秒响应请求数。在互联网领域，这个指标和吞吐量区分的没有这么明显。

4、并发用户数

并发用户数：同时承载正常使用系统功能的用户数量。例如一个即时通讯系统，同时在线量一定程度上
代表了系统的并发用户数。



#### 常用限流算法

（1）计数器

简单来说就是规定单位时间处理的请求数量规定单位时间处理的请求数量。

```java
public class Counter {
    public long startTime = System.currentTimeMillis(); // 当前时间
    public int reqCount = 0; // 初始化计数器
    public final int limit = 100; // 时间窗口内最大请求数
    public final long interval = 1000 * 60; // 时间窗口ms

    public boolean limit() {
        long now = System.currentTimeMillis();
        if (now - startTime < interval) {
            reqCount ++;
            // 判断当前时间窗口内是否超过最大请求控制数
            return reqCount <= limit;
        } else {
            reqCount = 1;
            return true;
        }
    }
}
```

（2）滑动窗口

滑动窗口计数器算法概念如下：

1、将时间划分为多个区间；

2、在每个区间内每有一次请求就将计数器加一维持一个时间窗口，占据多个区间；

3、每经过一个区间的时间，则抛弃最老的一个区间，并纳入最新的一个区间；

4、如果当前窗口内区间的请求计数总和超过了限制数量，则本窗口内所有的请求都被丢弃。



（3）漏桶算法

漏桶算法概念如下：

1、将每个请求视作"水滴"放入"漏桶"进行存储；

2、"漏桶"以固定速率向外"漏"出请求来执行如果"漏桶"空了则停止"漏水"；

3、如果"漏桶"满了则多余的"水滴"会被直接丢弃。



（4）令牌桶算法

令牌桶算法概念如下：

1、令牌以固定速率生成；

2、生成的令牌放入令牌桶中存放，如果令牌桶满了则多余的令牌会直接丢弃，当请求到达时，会尝试

从令牌桶中取令牌，取到了令牌的请求可以执行；

3、如果桶空了，那么尝试取令牌的请求会被直接丢弃



#### 限流的应用场景

天猫双11

12306

**前端限流：**浏览器、app、小程序

1、JS提交将按钮置灰

2、验证码、小游戏、问题回答

**接入层限流：**LVS

对地区限流

对IP限流

接入层指的是请求流量的入口，我们可以在这里做很多控制，比如：负载均衡，缓存，限流等。

**代理层限流：**

IP限流、用户限流、硬件设备限流(Android设备号)、连接数限流、其他限流策略

nginx中针对限流有两个模块可以处理：

1）ngx_http_limit_req_module；连接数限流模块

2）ngx_http_limit_conn_module；请求限流模块

连接数限流模块是基于计数器方式实现的，请求限流模块是基于漏桶算法实现的；

Nginx 常用于服务器反向代理，达到实现负载均衡和保护后端的应用服务器的目的。Nginx 主要通过限

制访问频率和并发连接数两种方式达到限制目的，Nginx 配置文件支持丰富的配置命令，比如下面一种

配置示例：

比如 limit_req_zone 的命令含义是对限制的对象（如 URL 地址、服务器地址和客户端 IP 地址等）设置

最大访问速率，zone 部分定义了共享内存区的名称和大小。

limit_conn 可以对指定的 IP 甚至是所在服务主机限制并发连接数量。

**服务层限流：**Tomcat、springboot

Server.xml：maxConnect（Http连接数限流）、maxThreads（线程数限流）

