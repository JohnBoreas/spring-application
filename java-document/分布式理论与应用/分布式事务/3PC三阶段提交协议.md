

区别2PC：

1、引入超时机制。同时在协调者和参与者中都引入超时机制。 

2、在第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前各参与节点的状态是一致的。 

引入超时机制之外，3PC把2PC的准备阶段再次一分为二 



三个阶段。

CanCommit

PreCommit

DoCommit

<img src="..\..\resource\3cp.png" style="zoom:67%;" />

CanCommit阶段 

​		3PC的CanCommit阶段其实和2PC的准备阶段很像。协调者向参与者发送commit请求，参与者如果可以 

提交就返回Yes响应，否则返回No响应。 

​		1.事务询问 协调者向参与者发送CanCommit请求。询问是否可以执行事务提交操作。然后开始等待参 

与者的响应。 

​		2.响应反馈 参与者接到CanCommit请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返 

回Yes响应，并进入预备状态。否则反馈No 



PreCommit阶段 

​		协调者根据参与者的反应情况来决定是否可以记性事务的PreCommit操作。根据响应情况，有以下两种 

可能。

​		假如协调者从所有的参与者获得的反馈都是Yes响应，那么就会执行事务的预执行。 

​		1.发送预提交请求 协调者向参与者发送PreCommit请求，并进入Prepared阶段。 

​		2.事务预提交 参与者接收到PreCommit请求后，会执行事务操作，并将undo和redo信息记录到事务日 

志中。

​		3.响应反馈 如果参与者成功的执行了事务操作，则返回ACK响应，同时开始等待最终指令。 

​		假如有任何一个参与者向协调者发送了No响应，或者等待超时之后，协调者都没有接到参与者的响应， 

那么就执行事务的中断。 

​				1.发送中断请求 协调者向所有参与者发送abort请求。**5.2 TCC****补偿**

​				2.中断事务 参与者收到来自协调者的abort请求之后（或超时之后，仍未收到协调者的请求），执行事 

务的中断。 



doCommit阶段 

​		该阶段进行真正的事务提交，也可以分为以下两种情况。 

​		执行提交

​				1.发送提交请求 协调接收到参与者发送的ACK响应，那么他将从预提交状态进入到提交状态。并向 

所有参与者发送doCommit请求。 

​				2.事务提交 参与者接收到doCommit请求之后，执行正式的事务提交。并在完成事务提交之后释放 

所有事务资源。 

​				3.响应反馈 事务提交完之后，向协调者发送Ack响应。 

​				4.完成事务 协调者接收到所有参与者的ack响应之后，完成事务。 



​		中断事务 协调者没有接收到参与者发送的ACK响应（可能是接受者发送的不是ACK响应，也可能响应超 

时），那么就会执行中断事务。 

​				1.发送中断请求 协调者向所有参与者发送abort请求 

​				2.事务回滚 参与者接收到abort请求之后，利用其在阶段二记录的undo信息来执行事务的回滚操 

作，并在完成回滚之后释放所有的事务资源。 

​				3.反馈结果 参与者完成事务回滚之后，向协调者发送ACK消息 

​				4.中断事务 协调者接收到参与者反馈的ACK消息之后，执行事务的中断。 

