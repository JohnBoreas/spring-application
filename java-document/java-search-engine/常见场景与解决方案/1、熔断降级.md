1、熔断

开关使用Redis开启关闭，脚本定时检测开关状态



2、限流

sentinel检测



Entry是Sentinel中用来表示请求是否通过限流的一个凭证。每次执行 `SphU.entry()` 或 `SphO.entry()` 都会返回一个 `Entry` 给调用者。资源调用结束时需要 `entry.exit()`。

```java
Entry entry = null;
try {
	entry = SphU.entry("myResource");
	// 被保护的业务逻辑
} catch (BlockException e1) {
	// 资源访问阻止，被限流或被降级
	// 进行相应的处理操作
} finally {
	if (entry != null) {
		entry.exit();
    }
}
```

定义限流规则：

```java
private void initRules() {
    // 配置规则
    List<FlowRule> rules = new ArrayList<>();
    FlowRule rule = new FlowRule();
    rule.setResource("myResource");	// 限流规则的作用对象
    // 配置规则：QPS不得超出10
    rule.setCount(10);	
    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);	// 设置限流阈值类型为QPS模式
    rule.setLimitApp("default");	// 针对的调用来源，default代表不区分来源
    rules.add(rule);
    // 加载规则
    FlowRuleManager.loadRules(rules);
}
```



熔断降级规则（DegradeRule）

```java
minRequestAmount	熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）
statIntervalMs		统计时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）
slowRatioThreshold	慢调用比例阈值，仅慢调用比例模式有效（1.8.0 引入）
// 
private DegradeRule getDegradeRule(String resource, int count, int degradeTime) {
        DegradeRule degradeRule = new DegradeRule(resource)// 资源名，即规则的作用对象
                // 当资源近 1 分钟的异常数目超过阈值之后会进行熔断。
                .setGrade(2)// 熔断策略，支持慢调用比例/异常比例/异常数策略	慢调用比例
                .setCount(count)// 慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例/异常数模式下为对应的阈值	
                .setTimeWindow(degradeTime);// 熔断时长，单位为 s	
        degradeRule.setLimitApp(applicationName);
        return degradeRule;
    }
```

















