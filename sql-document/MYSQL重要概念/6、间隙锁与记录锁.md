排它锁



#### 一、间隙锁（gap lock）

在可重复读提交下为了解决幻读问题时引入的锁机制

间隙锁是在索引记录之间的间隙上的锁，或在第一条索引记录之前或最后一条索引记录之后的间隙上的锁。



（1）**产生间隙锁的条件（RR事务隔离级别下；）：**

1. 使用普通索引锁定；
2. 使用多列唯一索引；
3. 使用唯一索引锁定多行记录。



（2）唯一索引

对于使用唯一索引来搜索并给某一行记录加锁的语句，不会产生间隙锁。

```sql
/* 这条语句，就只会产生记录锁，不会产生间隙锁。*/
SELECT * FROM child WHERE id = 100 FOR UPDATE;
/* 指定查询某一条记录的加锁语句，如果该记录不存在，会产生记录锁和间隙锁，如果记录存在，则只会产生记录锁 */
BEGIN;
SELECT * FROM `test` WHERE `id` = 3 FOR UPDATE;
SELECT SLEEP(30);
/** 对于查找某一范围内的查询语句，会产生间隙锁 */
SELECT * FROM `test` WHERE `id` BETWEEN 5 AND 7 FOR UPDATE;
```

（3）普通索引：

1. 在普通索引列上，**不管是何种查询，只要加锁，都会产生间隙锁，这跟唯一索引不一样；**
2. 在普通索引跟唯一索引中，数据间隙的分析，数据行是优先根据普通索引排序，再根据唯一索引排序。



（4）间隙锁是可重复读RR隔离级别下特有的，另外还有几种场景也会不使用间隙锁。

1. 事务隔离级别设置为读已提交RC ，这样肯定没有间隙锁了。
2. `Innodb_locks_unsafe_for_binlog`设置为1
3. 另外一种情况适用于**主键索引或者唯一索引**的等值查询条件，比如`select * from user where id=1`，`id`是主键索引，这样只使用Record Lock就可以了，因为能唯一锁定一条记录，所以没有必要再加间隙锁了，这是锁降级的过程。



#### 二、记录锁（Record Lock）

记录锁是 **封锁记录，记录锁也叫行锁**，是排它锁的一种

例如：

```sql
SELECT * FROM `test` WHERE `id`=1 FOR UPDATE;
```

它会在 id=1 的记录上加上记录锁，以阻止其他事务插入，更新，删除 id=1 这一行。



[记录锁的事务数据在InnoDB 监视器](https://dev.mysql.com/doc/refman/8.0/en/innodb-standard-monitor.html) 输出 [`SHOW ENGINE INNODB STATUS`](https://dev.mysql.com/doc/refman/8.0/en/show-engine.html)中 类似于以下内容：

```sql
RECORD LOCKS space id 58 page no 3 n bits 72 index `PRIMARY` of table `test`.`t`
trx id 10078 lock_mode X locks rec but not gap
Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 8000000a; asc     ;;
 1: len 6; hex 00000000274f; asc     'O;;
 2: len 7; hex b60000019d0110; asc        ;;
```



#### 三、临键锁(Next-key Locks)

**临键锁**，是**记录锁与间隙锁的组合**，它的封锁范围，既包含索引记录，又包含索引区间。

一个next-key lock  =  对应的索引记录的record lock  +  该索引**前面的**间隙的gap lock

比如索引有10，20，30几个值，那么被锁住的区间可能会是(-∞,10]，(10,20]，(20,30]，(30,+∞)。

**注：**临键锁的主要目的，也是为了避免**幻读**(Phantom Read)。如果把事务的隔离级别降级为RC，临键锁则也会失效。



[next-key 锁的事务数据在InnoDB 监视器](https://dev.mysql.com/doc/refman/8.0/en/innodb-standard-monitor.html) 输出 [`SHOW ENGINE INNODB STATUS`](https://dev.mysql.com/doc/refman/8.0/en/show-engine.html)中 类似于以下内容：

```sql
 RECORD LOCKS space id 58 page no 3 n bits 72 index `PRIMARY` of table `test`.`t`
trx id 10080 lock_mode X
Record lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0
 0: len 8; hex 73757072656d756d; asc supremum;;

Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 8000000a; asc     ;;
 1: len 6; hex 00000000274f; asc     'O;;
 2: len 7; hex b60000019d0110; asc        ;;
```