一、问题

服务器之间的数据如何保持一致性呢？

数据的读写操作是否每台服务器都可以处理？



二、主从复制模式

这个模式可以保证多台服务器的数据一致性，且主从服务器之间采用的是「读写分离」的方式。



主从复制共有三种模式：**全量复制、基于长连接的命令传播、增量复制**。



主从服务器间的第一次同步的过程可分为三个阶段：

- 第一阶段是建立链接、协商同步；
- 第二阶段是主服务器同步数据给从服务器；
- 第三阶段是主服务器发送新写操作命令给从服务器。

主从复制过程

![img](..\..\resource\redis主从复制过程.png)

**主服务器的 runID** 和**复制进度 offset**



1、先穿RDB文件，后续长连接发送写操作命令

2、采用异步方式复制数据到 slave 节点

3、slave不会过期 key，只会等待 master 过期 key。master过期发送del命令到slave

4、网络断开后采用增量复制





问题：

1、从服务器数量过多，而且都与主服务器进行全量同步的话，就会带来两个问题：

由于是通过 bgsave 命令来生成 RDB 文件的，那么主服务器就会忙于使用 fork() 创建子进程，如果主服务器的内存数据非大，在执行 fork() 函数时是会阻塞主线程的，从而使得 Redis 无法正常处理请求；
传输 RDB 文件会占用主服务器的网络带宽，会对主服务器响应命令请求产生影响。

2、数据不一致

问题不可避免，但可以优化

- 优化主从节点之间的网络环境（如在同机房部署）；
- 监控主从节点延迟（通过offset）判断，如果从节点延迟过大，通知应用不再通过该从节点读取数据；
- 使用集群同时扩展写负载和读负载等

3、主服务器怎么知道要将哪些增量数据发送给从服务器呢？

答案藏在这两个东西里：

**repl_backlog_buffer**，是一个「环形」缓冲区，用于主从服务器断连后，从中找到差异的数据；

**replication offset**，标记上面那个缓冲区的同步进度，主从服务器都有各自的偏移量，主服务器使用 master_repl_offset 来记录自己「写」到的位置，从服务器使用 slave_repl_offset 来记录自己「读」到的位置。